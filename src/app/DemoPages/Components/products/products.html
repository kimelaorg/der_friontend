<app-page-title [heading]="heading" [subheading]="subheading" [icon]="icon"></app-page-title>

<div class="row">
  <div class="col-lg-6 col-xl-4">
    <div class="card mb-3 widget-content">
      <div class="widget-content-wrapper">
        <div class="widget-content-left">
          <div class="widget-heading">Total Products</div>
          <div class="widget-subheading">Overall stock</div>
        </div>
        <div class="widget-content-right">
          <div class="widget-numbers text-success"><span>1896</span></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6 col-xl-4">
    <div class="card mb-3 widget-content">
      <div class="widget-content-wrapper">
        <div class="widget-content-left">
          <div class="widget-heading">Active Products</div>
          <div class="widget-subheading">Ready for sale</div>
        </div>
        <div class="widget-content-right">
          <div class="widget-numbers text-primary"><span>$ 568</span></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6 col-xl-4">
    <div class="card mb-3 widget-content">
      <div class="widget-content-wrapper">
        <div class="widget-content-left">
          <div class="widget-heading">Products Sold</div>
          <div class="widget-subheading">Total revenue streams</div>
        </div>
        <div class="widget-content-right">
          <div class="widget-numbers text-warning"><span>$14M</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card main-card mb-3">
  <div class="card-header">
    Manage Products and thier variants
  </div>
  <div class="card-body">

    <ul class="nav nav-tabs"
        [class.nav-justified]="currentJustify === 'justified'"
        [class.nav-fill]="currentJustify === 'fill'"
        [class.justify-content-center]="currentJustify === 'center'"
        [class.justify-content-end]="currentJustify === 'end'"
        id="justifiedTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="just-tab1-tab" data-bs-toggle="tab" data-bs-target="#just-tab1" type="button" role="tab" aria-controls="just-tab1" aria-selected="true">Simple</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="just-tab2-tab" data-bs-toggle="tab" data-bs-target="#just-tab2" type="button" role="tab" aria-controls="just-tab2" aria-selected="false"><b>Fancy</b> title</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="just-tab3-tab" data-bs-toggle="tab" data-bs-target="#just-tab3" type="button" role="tab" aria-controls="just-tab3" aria-selected="false">A very long nav title</button>
      </li>
    </ul>
    <div class="tab-content" id="justifiedTabContent">
      <div class="tab-pane fade show active" id="just-tab1" role="tabpanel" aria-labelledby="just-tab1-tab">
        <p class="mt-3">Raw denim you probably haven't heard of them jean shorts Austin. Nesciunt tofu stumptown aliqua,
          retro synth master cleanse. Mustache cliche tempor, williamsburg carles vegan helvetica. Reprehenderit butcher
          retro keffiyeh dreamcatcher synth. Cosby sweater eu banh mi, qui irure terry richardson ex squid.</p>
      </div>
      <div class="tab-pane fade" id="just-tab2" role="tabpanel" aria-labelledby="just-tab2-tab">
        <p class="mt-3">Food truck fixie locavore, accusamus mcsweeney's marfa nulla single-origin coffee squid.
          Exercitation +1 labore velit, blog sartorial PBR leggings next level wes anderson artisan four
          loko farm-to-table craft beer twee. Qui photo booth letterpress, commodo enim craft beer mlkshk aliquip jean shorts
          ullamco ad vinyl cillum PBR. Homo nostrud organic, assumenda labore aesthetic magna delectus mollit.</p>
      </div>
      <div class="tab-pane fade" id="just-tab3" role="tabpanel" aria-labelledby="just-tab3-tab">
        <p class="mt-3">Sed commodo, leo at suscipit dictum, quam est porttitor sapien, eget sodales nibh elit id diam.
          Nulla facilisi. Donec egestas ligula vitae odio interdum aliquet. Duis lectus turpis, luctus eget
          tincidunt eu, congue et odio. Duis pharetra et nisl at faucibus. Quisque luctus pulvinar arcu, et
          molestie lectus ultrices et. Sed diam urna, egestas ut ipsum vel, volutpat volutpat neque.</p>
      </div>
    </div>

    <div class="divider"></div>

    <div class="text-center">
      <div class="btn-group btn-group-toggle" role="group" aria-label="Tab justify options">
        <input type="radio" class="btn-check" name="justify" id="justify-start" value="start"
               [(ngModel)]="currentJustify" autocomplete="off">
        <label class="btn btn-outline-primary btn-sm" for="justify-start">Start</label>

        <input type="radio" class="btn-check" name="justify" id="justify-center" value="center"
               [(ngModel)]="currentJustify" autocomplete="off">
        <label class="btn btn-outline-primary btn-sm" for="justify-center">Center</label>

        <input type="radio" class="btn-check" name="justify" id="justify-end" value="end"
               [(ngModel)]="currentJustify" autocomplete="off">
        <label class="btn btn-outline-primary btn-sm" for="justify-end">End</label>

        <input type="radio" class="btn-check" name="justify" id="justify-fill" value="fill"
               [(ngModel)]="currentJustify" autocomplete="off">
        <label class="btn btn-outline-primary btn-sm" for="justify-fill">Fill</label>

        <input type="radio" class="btn-check" name="justify" id="justify-justified" value="justified"
               [(ngModel)]="currentJustify" autocomplete="off">
        <label class="btn btn-outline-primary btn-sm" for="justify-justified">Justified</label>
      </div>
    </div>
  </div>
</div>


<div class="p-4">
    <div class="mb-4">
        <h2>{{ heading }}</h2>
        <p class="text-muted">{{ subheading }}</p>
    </div>

    <div *ngIf="isLoading()" class="alert alert-info">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        <strong>Loading data...</strong>
    </div>
    <div *ngIf="message()" class="alert alert-info">{{ message() }}</div>

    ---

    <button class="btn btn-success mb-3" (click)="handleCreateProductModal()">
        <fa-icon [icon]="faPlus" class="me-2"></fa-icon> Create New Product
    </button>

    <div *ngIf="products().length === 0 && !isLoading()" class="alert alert-warning">
        No products found. Start by creating a new one!
    </div>

    <div *ngIf="products().length > 0">
        <h3 class="mt-4">Product Catalog ({{ products().length }})</h3>
        <div *ngFor="let product of products()" class="card mb-3 p-3 shadow-sm">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary">
                    {{ product.name }}
                    <span class="badge bg-secondary ms-2">ID: {{ product.id }}</span>
                    <span class="badge ms-2" [ngClass]="product.is_active ? 'bg-success' : 'bg-danger'">
                        {{ product.is_active ? 'Active' : 'Inactive' }}
                    </span>
                </h5>
                <div>
                    <button class="btn btn-sm btn-warning me-2" (click)="handleEditProductModal(product.id!)" title="Edit Base Product Details">
                        <fa-icon [icon]="faEdit"></fa-icon> Edit Product
                    </button>
                    <button class="btn btn-sm btn-info me-2" (click)="handleCreateSpecModal(product.id!)" title="Add New SKU/Specification">
                        <fa-icon [icon]="faPlus"></fa-icon> Add SKU
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="handleDeleteProductModal(product.id!)" title="Delete Product">
                        <fa-icon [icon]="faTrash"></fa-icon> Delete Product
                    </button>
                </div>
            </div>

            <p class="mt-1 mb-2 small text-muted">
                **Brand:** {{ lookupBrandName(product.brand) }} |
                **Category:** {{ lookupCategoryName(product.category) }}
            </p>

            <p class="text-secondary small mt-2 mb-0">
                **Specifications (SKUs):**
                <span *ngIf="!product.product_specs || product.product_specs.length === 0" class="fst-italic text-secondary ms-2">No SKUs defined.</span>

                <span *ngFor="let spec of product.product_specs" class="badge bg-light text-dark border me-2 my-1 d-inline-flex align-items-center">
                    {{ spec.sku }} ({{ spec.sale_price | currency }})

                    <a (click)="handleEditSpecModal(spec.id!, product.id!)" class="text-primary ms-2 cursor-pointer" title="Edit Specification">
                        <fa-icon [icon]="faEdit" size="xs"></fa-icon>
                    </a>
                    <a (click)="handleDeleteSpecModal(spec.id!, product.id!)" class="text-danger ms-1 cursor-pointer" title="Delete Specification">
                        <fa-icon [icon]="faTrash" size="xs"></fa-icon>
                    </a>
                </span>
            </p>
        </div>
    </div>

    ---

    <ng-template #productModal let-modal>
        <div class="modal-header">
            <h4 class="modal-title">{{ modalMode === 'create' ? 'Create New Product' : 'Edit Base Product Details' }}</h4>
            <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')"></button>
        </div>
        <form [formGroup]="productForm" (ngSubmit)="onAddProduct()">
            <div class="modal-body">
                <h5 class="mb-3 text-primary">Base Details</h5>

                <div class="mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input id="name" type="text" formControlName="name" class="form-control"
                            [class.is-invalid]="productForm.get('name')?.invalid && productForm.get('name')?.touched">
                    <div class="invalid-feedback" *ngIf="productForm.get('name')?.errors?.['required']">Name is required.</div>
                    <div class="invalid-feedback" *ngIf="productForm.get('name')?.errors?.['serverError']">
                        {{ productForm.get('name')?.errors?.['serverError'] }}
                    </div>
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" formControlName="description" class="form-control"
                                [class.is-invalid]="productForm.get('description')?.invalid && productForm.get('description')?.touched"></textarea>
                    <div class="invalid-feedback" *ngIf="productForm.get('description')?.errors?.['required']">Description is required.</div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="brand" class="form-label">Brand</label>
                        <select id="brand" formControlName="brand" class="form-select"
                                [class.is-invalid]="productForm.get('brand')?.invalid && productForm.get('brand')?.touched">
                            <option [ngValue]="null">Select Brand</option>
                            <option *ngFor="let brand of brands()" [ngValue]="brand.id">{{ brand.name }}</option>
                        </select>
                        <div class="invalid-feedback" *ngIf="productForm.get('brand')?.errors?.['required']">Brand is required.</div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select id="category" formControlName="category" class="form-select"
                                [class.is-invalid]="productForm.get('category')?.invalid && productForm.get('category')?.touched">
                            <option [ngValue]="null">Select Category</option>
                            <option *ngFor="let category of categories()" [ngValue]="category.id">{{ category.name }}</option>
                        </select>
                        <div class="invalid-feedback" *ngIf="productForm.get('category')?.errors?.['required']">Category is required.</div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label">Status</label>
                        <div class="d-flex align-items-center h-50">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="activeTrue" [value]="'true'" formControlName="is_active">
                                <label class="form-check-label" for="activeTrue">Active</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="activeFalse" [value]="'false'" formControlName="is_active">
                                <label class="form-check-label" for="activeFalse">Inactive</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">Cancel</button>
                <button type="submit" class="btn btn-primary" [disabled]="productForm.invalid || isLoading()">
                    <span *ngIf="isLoading()" class="spinner-border spinner-border-sm me-2"></span>
                    {{ modalMode === 'create' ? 'Save Product (Stage 1)' : 'Update Product' }}
                </button>
            </div>
        </form>
    </ng-template>


    <ng-template #specModal let-modal>
        <div class="modal-header">
            <h4 class="modal-title">{{ modalMode === 'create' ? 'Add New Specification (SKU)' : 'Edit Specification (SKU)' }}</h4>
            <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')"></button>
        </div>
        <form [formGroup]="specForm" (ngSubmit)="onAddProductSpec()">
            <div class="modal-body">
                <p class="text-info small">**Parent Product ID:** {{ currentSpecProductParentId }}</p>

                <div class="row">
                    <input type="hidden" formControlName="id">

                    <div class="col-md-6 mb-3">
                        <label for="sku" class="form-label">SKU</label>
                        <input id="sku" type="text" formControlName="sku" class="form-control"
                                [class.is-invalid]="specForm.get('sku')?.invalid && specForm.get('sku')?.touched">
                        <div class="invalid-feedback" *ngIf="specForm.get('sku')?.errors?.['required']">SKU is required.</div>
                        <div class="invalid-feedback" *ngIf="specForm.get('sku')?.errors?.['serverError']">
                            {{ specForm.get('sku')?.errors?.['serverError'] }}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="color" class="form-label">Color (Optional)</label>
                        <input id="color" type="text" formControlName="color" class="form-control">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="screen_size" class="form-label">Screen Size</label>
                        <select id="screen_size" formControlName="screen_size" class="form-select"
                                [class.is-invalid]="specForm.get('screen_size')?.invalid && specForm.get('screen_size')?.touched">
                            <option [ngValue]="null">Select Size</option>
                            <option *ngFor="let size of screenSizes()" [ngValue]="size.id">{{ size.name }}</option>
                        </select>
                        <div class="invalid-feedback" *ngIf="specForm.get('screen_size')?.errors?.['required']">Required.</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="resolution" class="form-label">Resolution</label>
                        <select id="resolution" formControlName="resolution" class="form-select"
                                [class.is-invalid]="specForm.get('resolution')?.invalid && specForm.get('resolution')?.touched">
                            <option [ngValue]="null">Select Resolution</option>
                            <option *ngFor="let res of resolutions()" [ngValue]="res.id">{{ res.name }}</option>
                        </select>
                        <div class="invalid-feedback" *ngIf="specForm.get('resolution')?.errors?.['required']">Required.</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="panel_type" class="form-label">Panel Type</label>
                        <select id="panel_type" formControlName="panel_type" class="form-select"
                                [class.is-invalid]="specForm.get('panel_type')?.invalid && specForm.get('panel_type')?.touched">
                            <option [ngValue]="null">Select Panel</option>
                            <option *ngFor="let panel of panelTypes()" [ngValue]="panel.id">{{ panel.name }}</option>
                        </select>
                        <div class="invalid-feedback" *ngIf="specForm.get('panel_type')?.errors?.['required']">Required.</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-5 mb-3">
                        <label for="original_price" class="form-label">Original Price</label>
                        <input id="original_price" type="number" formControlName="original_price" class="form-control"
                                [class.is-invalid]="specForm.get('original_price')?.invalid && specForm.get('original_price')?.touched">
                        <div class="invalid-feedback" *ngIf="specForm.get('original_price')?.errors?.['required']">Required.</div>
                    </div>
                    <div class="col-md-5 mb-3">
                        <label for="sale_price" class="form-label">Sale Price</label>
                        <input id="sale_price" type="number" formControlName="sale_price" class="form-control"
                                [class.is-invalid]="specForm.get('sale_price')?.invalid && specForm.get('sale_price')?.touched">
                        <div class="invalid-feedback" *ngIf="specForm.get('sale_price')?.errors?.['required']">Required.</div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Smart?</label>
                        <div class="d-flex align-items-center h-50">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="smartTrue" [value]="'true'" formControlName="smart_features">
                                <label class="form-check-label" for="smartTrue">Y</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="smartFalse" [value]="'false'" formControlName="smart_features">
                                <label class="form-check-label" for="smartFalse">N</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3 mt-3">
                    <label class="form-label d-block text-secondary">Supported Internet Services</label>
                    <div class="d-flex flex-wrap border rounded p-2 bg-white">
                        <div *ngFor="let service of availableInternetServices()" class="form-check form-check-inline">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                [id]="'service-spec-' + service.id"
                                [checked]="selectedInternetServices().includes(service.id!)"
                                (change)="toggleInternetServiceSelection(service.id!)">
                            <label class="form-check-label" [for]="'service-spec-' + service.id">{{ service.name }}</label>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">Cancel</button>
                <button type="submit" class="btn btn-primary" [disabled]="specForm.invalid || isLoading()">
                    <span *ngIf="isLoading()" class="spinner-border spinner-border-sm me-2"></span>
                    {{ modalMode === 'create' ? 'Save Specification' : 'Update Specification' }}
                </button>
            </div>
        </form>
    </ng-template>

    <ng-template #deleteProductModal let-modal>
        <div class="modal-header">
            <h4 class="modal-title text-danger">Confirm Product Deletion</h4>
            <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')"></button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this product (ID: **{{ currentProductId }}**)? This action cannot be undone.</p>
            <p class="text-danger small">Note: Deleting a product will also delete all associated specifications (SKUs).</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">Cancel</button>
            <button type="button" class="btn btn-danger" (click)="onDeleteProduct()" [disabled]="isLoading()">
                <span *ngIf="isLoading()" class="spinner-border spinner-border-sm me-2"></span>
                Delete
            </button>
        </div>
    </ng-template>

    <ng-template #deleteSpecModal let-modal>
        <div class="modal-header">
            <h4 class="modal-title text-danger">Confirm SKU Deletion</h4>
            <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')"></button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this specification (SKU ID: **{{ currentSpecId }}**) from Product ID: **{{ currentSpecProductParentId }}**?</p>
            <p class="text-danger small">This action cannot be undone and will permanently remove this specific SKU and its pricing/details.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">Cancel</button>
            <button type="button" class="btn btn-danger" (click)="onDeleteSpec()" [disabled]="isLoading()">
                <span *ngIf="isLoading()" class="spinner-border spinner-border-sm me-2"></span>
                Delete SKU
            </button>
        </div>
    </ng-template>

</div>
