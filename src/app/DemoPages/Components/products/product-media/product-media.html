<div class="table-responsive">
  <table class="align-middle text-truncate mb-0 table table-borderless table-hover">
    <thead>
      <tr>
        <th scope="col">Id</th>
        <th scope="col">Product Name</th>
        <th scope="col">Model No.</th>
        <th scope="col">Product Discounted Price</th>
        <th scope="col">Product Actual Price</th>
        <th scope="col" class="text-center">Images</th>
        <th scope="col" class="text-center">Videos</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let product of products()">
        <td>{{ product.id }}</td>
        <td>{{ product.productName }}</td>
        <td>{{ product.model_number }}</td>
        <td>
          <span class="fw-bold text-success">{{ product.productDiscountedPrice | currency: 'TZS': 'symbol' }}</span>
        </td>
        <td>
          <span class="text-muted text-decoration-line-through">{{ product.productActualPrice | currency: 'TZS': 'symbol' }}</span>
        </td>
        <td class="text-center">
          <button class="btn btn-sm btn-outline-info" (click)="openMediaModal(product, imageContent)" title="View/Manage Images">
            <fa-icon [icon]="faImage"></fa-icon>&nbsp;({{ product.images.length }})
          </button>
        </td>
        <td class="text-center">
          <button class="btn btn-sm btn-outline-info" (click)="openMediaModal(product, videoContent)" title="View/Manage Videos">
            <fa-icon [icon]="faVideo"></fa-icon>&nbsp;({{ product.videos.length }})
          </button>
        </td>

      </tr>
    </tbody>
  </table>
</div>


<ng-template #imageContent let-modal>

  <div class="modal-header">
    <h4 class="modal-title" id="modal-image-title" *ngIf="selectedProduct">
      Images for: **{{ selectedProduct.productName }}** (ID: {{ selectedProduct.id }})
    </h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>

  <div class="modal-body" *ngIf="selectedProduct">

    <div *ngIf="generalModalError" class="alert alert-danger" role="alert">
        {{ generalModalError }}
    </div>

    <div *ngIf="selectedProduct.images.length > 0" class="mb-4">
      <h4>Existing Images ({{ selectedProduct.images.length }})</h4>
      <div class="image-grid">
        <div *ngFor="let imageObject of selectedProduct.images" class="image-container">

          <a href="javascript:void(0)"
             (click)="openImageViewer(imageObject.url, imageViewerContent)"
             class="image-preview-link"
             title="Click to View Image">
            <img [src]="imageObject.url" alt="Product Image" class="img-thumbnail image-preview-thumbnail">
          </a>

          <button class="btn btn-sm btn-danger delete-image-btn" (click)="deleteProductMedia(imageObject.url, 'image')">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="card p-3"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event)"
          [class.no-images-placeholder]="selectedProduct.images.length === 0">

      <h4 class="text-center" *ngIf="selectedProduct.images.length === 0">
        No images found for this product.
      </h4>

      <p class="text-center text-muted">Drag & Drop image files here or click to select.</p>

      <input
        type="file"
        id="fileUploadImage" multiple
        (change)="onFileSelect($event)"
        style="display: none;"
        #fileInputImage
        accept="image/*">

      <div *ngIf="fieldValidationErrors['image']" class="text-danger small mt-1">
          <div *ngFor="let error of fieldValidationErrors['image']">{{ error }}</div>
      </div>

      <div class="d-grid gap-2 col-6 mx-auto">
        <button
          type="button"
          class="btn btn-outline-primary"
          onclick="document.getElementById('fileUploadImage').click()">
          <fa-icon [icon]="faImage"></fa-icon> Select and Upload Images
        </button>
      </div>
    </div>

    <div *ngIf="filesToUpload.length > 0" class="mt-3">
      <h6>Files Staged ({{ filesToUpload.length }})</h6>
      <ul class="list-group">
        <li *ngFor="let file of filesToUpload" class="list-group-item d-flex justify-content-between align-items-center">
          {{ file.name }}
          <span class="badge bg-secondary rounded-pill">{{ file.size / 1024 | number: '1.0-2' }} KB</span>
        </li>
      </ul>
    </div>

  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close('Cancel click')">Cancel</button>

    <button
      type="button"
      class="btn btn-success"
      [disabled]="filesToUpload.length === 0"
      (click)="uploadStagedFiles('image')"> Upload ({{ filesToUpload.length }})
    </button>
  </div>
</ng-template>


<ng-template #videoContent let-modal>

  <div class="modal-header">
    <h4 class="modal-title" id="modal-video-title" *ngIf="selectedProduct">
      Videos for: **{{ selectedProduct.productName }}** (ID: {{ selectedProduct.id }})
    </h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>

  <div class="modal-body" *ngIf="selectedProduct">

    <div *ngIf="generalModalError" class="alert alert-danger" role="alert">
        {{ generalModalError }}
    </div>

    <div *ngIf="selectedProduct.videos.length > 0" class="mb-4">
      <h4>Existing Videos ({{ selectedProduct.videos.length }})</h4>
      <div class="video-grid">
        <div *ngFor="let videoObject of selectedProduct.videos" class="video-container">

          <a href="javascript:void(0)"
             (click)="openVideoPlayer(videoObject.url, videoPlayerContent)"
             class="d-block video-preview-link text-center border p-2 rounded"
             title="Click to Play Video">

            <fa-icon [icon]="faVideo" class="fa-2xl text-secondary d-block p-4"></fa-icon>

            <div class="video-filename text-truncate small text-muted mt-1">
                 {{ videoObject.url | slice:0:50 }}...
            </div>
          </a>

          <button class="btn btn-sm btn-danger delete-video-btn" (click)="deleteProductMedia(videoObject.url, 'video')">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="card p-3"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event)"
          [class.no-videos-placeholder]="selectedProduct.videos.length === 0">

      <h4 class="text-center" *ngIf="selectedProduct.videos.length === 0">
        No videos found for this product.
      </h4>

      <p class="text-center text-muted">Drag & Drop video files here or click to select.</p>

      <input
        type="file"
        id="fileUploadVideo"
        multiple
        (change)="onFileSelect($event)"
        style="display: none;"
        #fileInputVideo
        accept="video/*">

        <div *ngIf="fieldValidationErrors['video']" class="text-danger small mt-1">
          <div *ngFor="let error of fieldValidationErrors['video']">{{ error }}</div>
        </div>

      <div class="d-grid gap-2 col-6 mx-auto">
        <button
          type="button"
          class="btn btn-outline-primary"
          onclick="document.getElementById('fileUploadVideo').click()">
          <fa-icon [icon]="faVideo"></fa-icon> Select and Upload Videos
        </button>
      </div>
    </div>

    <div *ngIf="filesToUpload.length > 0" class="mt-3">
      <h6>Files Staged ({{ filesToUpload.length }})</h6>
      <ul class="list-group">
        <li *ngFor="let file of filesToUpload" class="list-group-item d-flex justify-content-between align-items-center">
          {{ file.name }}
          <span class="badge bg-secondary rounded-pill">{{ file.size / 1024 / 1024 | number: '1.0-2' }} MB</span>
        </li>
      </ul>
    </div>

  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close('Cancel click')">Cancel</button>

    <button
      type="button"
      class="btn btn-success"
      [disabled]="filesToUpload.length === 0"
      (click)="uploadStagedFiles('video')"> Upload ({{ filesToUpload.length }})
    </button>
  </div>
</ng-template>


<ng-template #imageViewerContent let-modal>
    <div class="modal-header">
        <h5 class="modal-title" id="modal-image-viewer">Image Viewer</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>

    <div class="modal-body text-center p-0">
        <div *ngIf="selectedImageUrl" class="w-100 h-100 p-3">
            <img
                [src]="selectedImageUrl"
                alt="Full Size Product Image"
                class="img-fluid border rounded"
                style="max-height: 80vh; max-width: 100%;">
        </div>
        <div *ngIf="!selectedImageUrl" class="p-5 text-muted">
            Error loading image URL.
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close('Close click')">Close</button>
    </div>
</ng-template>


<ng-template #videoPlayerContent let-modal>
    <div class="modal-header bg-dark text-white border-0">
        <h5 class="modal-title" id="modal-video-player">Video Playback</h5>
        <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>

    <div class="modal-body bg-dark text-center p-0">
        <div *ngIf="selectedVideoUrl" class="w-100 h-100">
            <video
                [src]="selectedVideoUrl"
                controls
                autoplay
                class="w-100"
                style="max-height: 80vh;">
                Your browser does not support the video tag.
            </video>
        </div>
        <div *ngIf="!selectedVideoUrl" class="text-white-50 p-5">
            Error loading video URL.
        </div>
    </div>

    <div class="modal-footer bg-dark border-0">
        <button type="button" class="btn btn-secondary" (click)="modal.close('Close click')">Close</button>
    </div>
</ng-template>


<ng-template #confirmDeletion let-modal>
  <div class="modal-header">
    <h4 class="modal-title text-danger">Confirm Deletion</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cancel click')"></button>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to delete this file? This action cannot be undone.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="modal.close('Delete click')">Delete</button>
  </div>
</ng-template>
