<div class="table-responsive">
  <table class="align-middle text-truncate mb-0 table table-borderless table-hover">
    <thead>
      <tr>
        <th scope="col">Id</th>
        <th scope="col">Product Name</th>
        <th scope="col">Product Description</th>
        <th scope="col">Product Discounted Price</th>
        <th scope="col">Product Actual Price</th>
        <th scope="col">Images</th>
        <th scope="col" colspan="2">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let product of products()">
        <td>{{ product.id }}</td>
        <td>{{ product.productName }}</td>
        <td>{{ product.productDescription }}</td>
        <td>
          <span class="fw-bold text-success">{{ product.productDiscountedPrice | currency: 'TZS': 'symbol' }}</span>
        </td>
        <td>
          <span class="text-muted text-decoration-line-through">{{ product.productActualPrice | currency: 'TZS': 'symbol' }}</span>
        </td>
        <td class="text-center">
          <button class="btn btn-sm btn-outline-info" (click)="openImageModal(product, imageContent)" title="View/Manage Images">
            <i class="bi bi-image"></i> üñºÔ∏è ({{ product.images.length }})
          </button>
        </td>
        <td>
          </td>
        <td>
          </td>
      </tr>
    </tbody>
  </table>
</div>

<ng-template #imageContent let-modal>

  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title" *ngIf="selectedProduct">
      Images for: {{ selectedProduct.productName }} (ID: {{ selectedProduct.id }})
    </h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>

  <div class="modal-body" *ngIf="selectedProduct">

    <div *ngIf="generalModalError" class="alert alert-danger" role="alert">
        {{ generalModalError }}
    </div>

    <div *ngIf="selectedProduct.images.length > 0" class="mb-4">
      <h4>Existing Images ({{ selectedProduct.images.length }})</h4>
      <div class="image-grid">
        <div *ngFor="let imageObject of selectedProduct.images" class="image-container">
          <img [src]="imageObject.url" alt="Product Image" class="img-thumbnail">
          <button class="btn btn-sm btn-danger delete-image-btn" (click)="deleteProductImage(imageObject.url)">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="card p-3"
         (dragover)="onDragOver($event)"
         (drop)="onDrop($event)"
         [class.no-images-placeholder]="selectedProduct.images.length === 0">

      <h4 class="text-center" *ngIf="selectedProduct.images.length === 0">
        No images found for this product.
      </h4>

      <p class="text-center text-muted">Drag & Drop images here or click to select.</p>

      <input
        type="file"
        id="fileUpload"
        multiple
        (change)="onFileSelect($event)"
        style="display: none;"
        #fileInput>

      <div *ngIf="fieldValidationErrors['image']" class="text-danger small mt-1">
          <div *ngFor="let error of fieldValidationErrors['image']">{{ error }}</div>
      </div>

      <div class="d-grid gap-2 col-6 mx-auto">
        <button
          type="button"
          class="btn btn-outline-primary"
          onclick="document.getElementById('fileUpload').click()">
          <i class="bi bi-upload"></i> Select and Upload Images
        </button>
      </div>
    </div>

    <div *ngIf="filesToUpload.length > 0" class="mt-3">
      <h6>Files Staged ({{ filesToUpload.length }})</h6>
      <ul class="list-group">
        <li *ngFor="let file of filesToUpload" class="list-group-item d-flex justify-content-between align-items-center">
          {{ file.name }}
          <span class="badge bg-secondary rounded-pill">{{ file.size / 1024 | number: '1.0-2' }} KB</span>
        </li>
      </ul>
    </div>

  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close('Cancel click')">Cancel</button>

    <button
      type="button"
      class="btn btn-success"
      [disabled]="filesToUpload.length === 0"
      (click)="uploadStagedFiles()">
      Upload ({{ filesToUpload.length }})
    </button>
  </div>
</ng-template>

<ng-template #confirmDeletion let-modal>
  <div class="modal-header">
    <h4 class="modal-title text-danger">Confirm Deletion</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cancel click')"></button>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to delete this image? This action cannot be undone.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="modal.close('Delete click')">Delete</button>
  </div>
</ng-template>
